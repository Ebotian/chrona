### Chrono-Stasis 实现方案（技术选型 & 脚手架计划）

#### 1. 项目总体策略

- 建立在 Next.js 15（App Router + React 19 + TypeScript 5.x）之上的全栈架构，充分利用 Vercel 原生优势（Edge Functions、ISR、Server Actions、图像优化、缓存策略）。
- 采用模块化单仓（monorepo）思路：主站 + 动效/渲染子包 + 设计 token，共用 `pnpm` 工作区与 Nx/Turborepo 任务编排，利于多人协作与 CI 并行。
- 渐进增强：首屏 SSR/SSG，进入互动区块时按需激活 WebGL、音效、滚动驱动动画；对低性能设备自动降级。
- 内容形态以 MDX + Headless CMS 并存：快速迭代阶段使用 MDX 驱动；后续接入 Sanity（或 Hygraph）实现结构化数据与协作工作流；通过 Contentlayer 统一接口。

#### 2. 技术选型明细

- **前端框架**：Next.js 15（App Router），React Server Components + Client Components 混合。
- **语言 & 工具链**：TypeScript 5.x、ESLint（Next 官方规则 + 自定义动效 lint）、Prettier、Commitlint/Conventional Commits。
- **包管理与构建**：`pnpm` + Turborepo；Development 使用 Turbopack，CI 构建沿用 Next 构建任务。
- **渲染与动效**：`three`、`@react-three/fiber`、`@react-three/drei`、`postprocessing`、`framer-motion`、`gsap`（时间线）、`lenis`（滚动平滑）、`leva`（调试面板）。
- **样式体系**：CSS Modules + CSS Variables 搭配 `vanilla-extract`（定义设计 token）、`tailwindcss`（快速布网与响应式语义类）；Radix UI primitives 作为无障碍组件基底。
- **内容层**：Contentlayer + MDX（短期）；Sanity + `next-sanity`（中期，可通过 ENV 切换）；全局使用自定义 `MDXComponents` 实现 Scene/Keyframe/Dialogue 等模块。
- **状态管理**：`zustand`（偏 UI 状态）、React Context（动效首选项、音效开关）；数据层使用 Next 内置 fetch cache + React Query 处理客户端交互数据。
- **音效 & 多媒体**：`tone.js`（背景氛围）、`howler.js`（短音效）；Web Audio API Hook；移动端封装振动 API。
- **图像/资产处理**：Next Image、`sharp`、`glslify` loader（着色器）、`lottie-react`/`rive-react`（Logo/HUD）。
- **测试体系**：Vitest（单测 + 组件）、Playwright（E2E、动效断言）、Lighthouse CI（性能回归）、Chromatic（Storybook 可视回归）。
- **监控与分析**：Vercel Analytics、Sentry（前端 + Edge）、Amplitude（交互事件）。
- **部署与运维**：Vercel（Preview/Production）；GitHub Actions 驱动 lint/test/storybook 构建；使用 Vercel 环境变量管理密钥。

#### 3. 脚手架搭建步骤

1. **初始化仓库**
   - `pnpm init` → 新建 `pnpm-workspace.yaml` 定义 packages：`apps/web`、`packages/ui`、`packages/motion`、`packages/tokens`。
   - 引入 Turborepo：`pnpm add -D turbo`，配置 `turbo.json`（lint/test/build/storybook pipelines）。
   - 添加 git hooks：Husky + lint-staged + commitlint。

2. **Next.js 应用基座（apps/web）**
   - `pnpm create next-app --example with-turbo --typescript` 或使用 `create-next-app@latest` 后迁入 monorepo。
   - 启用 App Router、`experimental.serverActions`、`typedRoutes`、` instrumentationHook`。
   - 配置 `next.config.mjs`：开启 `images.remotePatterns`、`webpack` 自定义（GLSL loader、three.js alias、build output tracing）。
   - 设置 `tsconfig.json` 基础路径别名（`@ui/*`, `@motion/*`, `@tokens/*`）。

3. **UI 设计系统（packages/ui）**
   - `vanilla-extract` + `tailwindcss` + `postcss`；抽象栅格、色板、排印、HUD 元件。
   - 引入 Radix Primitives + 自定义组件（导航 HUD、Tag Nebula、Cinematic Header、Timeline Beacon）。
   - 建 Storybook 8 支持（Vite builder），与设计 token 同步。

4. **动效与渲染引擎（packages/motion）**
   - 封装 `three` 场景、R3F 组件（粒子云、光束、关键帧播放器、Glitch Shader）。
   - 提供统一 hooks（`useParallaxScene`, `useAudioReactiveShader`, `useReducedMotionGuard`）。
   - 维护 `gsap` 时间线配置预设，导出用于页面级动画。

5. **设计 Token（packages/tokens）**
   - 使用 `vanilla-extract` createTheme + `style-dictionary` 输出多格式（CSS vars、JSON、TS）。
   - 定义色彩、排版、间距、动效节奏、阴影、噪点强度、GLSL 常量。

6. **内容层接入**
   - 先集成 Contentlayer + MDX，定义文档 schema（frontmatter、动效配置、音效引用）。
   - 封装 `MDXComponents`（SceneParagraph、KeyframePlayer、DialogueCapsule、HolographicTerminal 等）。
   - 预留 CMS 接口：抽象 `getChronoEntries()`，可切换至 Sanity 数据源。

7. **系统功能实现基线**
   - **首页**：Preloader（R3F + 音效）、动态背景（点云 shader）、Slogan 动效（shaderMaterial）、入口按钮（Framer Motion + GSAP timeline）、音效控制器。
   - **文章列表**：非对称网格布局（CSS Grid + Tailwind utilities）、卡片 Hover 状态机（Framer Motion）、视差滚动（Lenis + Scroll-based uniforms）、过滤器面板（Radix Dialog + R3F 背景模糊）。
   - **详情页**：Cinematic Header（Intersection Observer 控制）、Scene Paragraph（MDX 渲染 + 动画）、Keyframe 模块（R3F scroll controls）、引用块（光束动画）、代码终端（Radix Tabs + copy hook）、Image Lab（Next Image + shader overlay）。
   - **全局模块**：HUD Menu（Radix Dialog + Motion）、Tag Nebula（R3F particle system）、评论面板（Headless UI + WebSocket/静态占位）、作者名片（动画边框）。

##### Homepage Immersion Layer 单人 / 单日实施蓝图（AI 自动化友好）

**范围与目标**

- 在 `apps/web` 完成首屏沉浸式体验 MVP：包含 Preloader → 动态背景 → Slogan & CTA → 环境音控制器 的串联时间线，桌面端优先，移动端提供降级策略。
- 利用 `packages/motion` 现有 Hook（`useChronoScrollContext`, `useChronoShaderUniforms`, `useChronoScene`）快速接入滚动/Shader 能力，并保持与 Playground Demo 的实现一致性。

**期望交付物**

- `apps/web/app/(home)/page.tsx`：首屏布局，接入 Suspense + Lazy canvas。
- `apps/web/components/home/*`：Preloader、BackgroundCanvas、SloganCluster、AudioToggle 等模块化组件。
- `apps/web/styles/homepage.css` 或等效 `vanilla-extract` 文件：首屏基础样式与降级方案。
- `packages/motion/src/presets/homepage.ts`：封装首页专用 ShaderUniforms/GSAP timeline 预设（复用 Playground 工具函数）。
- QA 资产：Lighthouse 报告、Playwright 场景脚本草案（可标记 TODO）。
- 更新后的设计文档记录（即本节）。

**必备前置条件**

- `pnpm install` 及 `pnpm turbo run lint` 已通过；`packages/tokens` build 仍可暂缓。
- 设计参考：`新构想.md` 中 Homepage 段落 + 粒子点云与 Logo 时间线描述。
- 噪点纹理、Logo 轮廓 SVG 若缺失，可先用占位，标记 TODO。

**时间分块（09:30-18:00）**

- 09:30-10:30 — 结构搭建：创建页面骨架、定义组件目录、接入 Reduced Motion/Scroll Context。
- 10:30-12:00 — Preloader & Boot Timeline：实现 Logo 绘制动画、状态机、与 Lenis/滚动初始化衔接。
- 13:00-14:30 — 动态背景与 Shader Uniform：从 Playground 粒子云提取核心逻辑，封装为首页 Canvas，完成鼠标交互与性能降级。
- 14:30-16:00 — Slogan 动效 + CTA：实现段落排版、流体 shader、按钮交互、Framer Motion/GSAP 时间线与 Canvas 同步。
- 16:00-17:00 — 音效控制器 + 状态同步：集成 `howler.js` 或 `tone.js` 占位，完成 UI 与全局偏好存储。
- 17:00-18:00 — 调试 & 打包：Lighthouse 快速扫、Playwright 脚本框架、更新文档和临时记忆栈。

**实施任务矩阵（按模块拆解）**

1. Preloader & State Orchestration
   - 目标：复现 Logo 线条描绘 → 缩放吸附左上角的时间线。
   - 主要文件：`components/home/Preloader.tsx`, `components/home/useHomeTimeline.ts`。
   - 操作指引：
     - 拆分阶段（描边 / 信号闪烁 / 缩放）；使用 `gsap.timeline({ defaults: { ease: "power2.out" } })`。
     - 为可访问性提供 `prefers-reduced-motion` 判断，必要时跳过动画并直接渲染主内容。
   - 自动化提示模板：
     - 「请在 `components/home/Preloader.tsx` 创建 React 组件，使用 R3F `<Canvas>` 绘制 Logo Path，暴露 `onComplete` 回调以解除主内容遮罩。」
   - 验收标准：`pnpm --filter apps/web lint` 无错；Preloader 完成后 `onComplete` 触发一次。

2. Background Nebula Canvas
   - 目标：提供点云 + 代码雨叠层，响应鼠标偏移；低性能设备降级为静态图。
   - 文件：`components/home/BackgroundCanvas.tsx`, `components/home/background/uniforms.ts`。
   - 操作：
     - 从 `@chrono/motion-playground` 的 `NebulaParticlesScene` 提取 shader，缩减 uniform 只保留必要项。
     - 使用 `useReducedMotionGuard` 确定是否启用低配模式，低配下渲染静态 PNG/SVG。
   - 自动化提示模板：
     - 「复用 `createBackgroundMaterial` 工具，生成粒子系统，增加 `hoverDisplacement` uniform 并通过 `useFrame` 更新。」
   - 验收：Chrome DevTools Performance ≥ 55fps（桌面），低配模式帧率稳定；`pnpm --filter apps/web test` 通过组件快照测试。

3. Slogan Cluster & CTA
   - 目标：构建标题、描述、入口按钮及交互动画。
   - 文件：`components/home/SloganCluster.tsx`, `components/home/sloganMotion.ts`, `components/home/cta.module.css`。
   - 操作：
     - 使用 `framer-motion` 的 `motion.div` 与 `clipPath` 模拟流体扰动；必要时注入自定义 shader 作为 `background`。
     - CTA 按钮 Hover 时触发 Spiral Scan（可用 `radial-gradient` + keyframes）。
   - 自动化提示模板：
     - 「实现一个包含标题/副标题/按钮的组件，提供 `animateIn()` 方法，与 Preloader 完成后串联。」
   - 验收：Accessibility 核验（Tab 焦点、ARIA 标签），按钮点击触发模拟导航（控制台输出 TODO）。

4. Audio Controller & Global State
   - 目标：实现右下角环境音控制器，支持记忆用户偏好。
   - 文件：`components/home/AudioToggle.tsx`, `stores/useAudioPreference.ts`, `hooks/useAmbientSound.ts`。
   - 操作：
     - 基于 `zustand` 建立 `useAudioPreference`；`useAmbientSound` 内使用 `tone.js` 或 `howler.js` 创建声音实例。
     - 提供 `muted` 状态与 `setMuted` 方法；移动端默认静音。
   - 自动化提示模板：
     - 「创建 `useAudioPreference` store，默认 `muted: true`，将用户操作写入 `localStorage`。」
   - 验收：控制器按钮在 Desktop/Touch 均可操作；无控制台错误。

5. Integration & QA Envelope
   - 目标：整合模块、处理 Suspense/lazy、添加测试钩子。
   - 文件：`app/(home)/page.tsx`, `app/(home)/HomeImmersionLayer.tsx`, `tests/homepage.spec.ts`。
   - 操作：
     - 通过 `dynamic(() => import(...), { ssr: false })` 懒加载 Canvas；SSR 端输出语义化占位。
     - 加入 Playwright 场景骨架（`test.describe('homepage immersion', ...)`），标记 TODO。
     - 执行 Lighthouse (`pnpm run lint:ux` 预留）记录性能和无障碍基线。
   - 自动化提示模板：
     - 「在 `page.tsx` 中挂载 `HomeImmersionLayer`，SSR 返回 `<main>` 包裹，并在客户端渲染时解除 Preloader。」
   - 验收：`pnpm --filter apps/web lint`, `pnpm --filter apps/web build` 通过；Lighthouse Performance ≥ 50（初版目标）。

**自动验证命令清单**

- `pnpm --filter apps/web lint`
- `pnpm --filter apps/web build`
- `pnpm --filter apps/web test -- --watch=false`
- `pnpm exec playwright test tests/homepage.spec.ts --project=chromium --config=playwright.config.ts`（若脚本未完备可加 `--reporter=list` 并允许 TODO）
- `pnpm run lighthouse:home -- --url=http://localhost:3000`（需先 `pnpm --filter apps/web dev` 启动，命令可留作占位）

**完成判定 Checklist**

- [ ] Preloader 时间线在桌面端可完整播放，Reduced Motion 下自动跳过。
- [ ] 动态背景在高配帧率 ≥ 55fps，低配降级正常。
- [ ] Slogan & CTA 与 Canvas 同步，交互动效与可访问性检查通过。
- [ ] 音效控制器可记忆用户偏好，移动端默认静音。
- [ ] Playwright/Lighthouse 报告已生成并归档至 `docs/reports/2025-10-30/`（若为空则保留 TODO）。
- [ ] 文档与临时记忆栈更新，注明剩余风险或待办。

8. **可访问性与性能**
   - 实现动效总开关（`prefers-reduced-motion` + 用户偏好存储于 localStorage/zustand）。
   - 交互组件全部提供键盘支持、Focus 样式、电浆蓝高对比。
   - WebGL 场景懒加载（`dynamic(import, { ssr: false })` + `useInView`），低端设备降级为静态 Canvas/SVG。
   - 使用 `next/script` 控制第三方脚本；通过 `next/font` 引入自托管字体。

9. **测试与质量流程**
   - `pnpm lint`, `pnpm test`, `pnpm test:e2e`, `pnpm test:visual` Pipeline。
   - Storybook + Chromatic CI（PR 自动截图 diff）。
   - Playwright 针对核心动效（Preloader、关键帧模块、过滤器）编写场景脚本。
   - Lighthouse CI 集成（阈值：Performance ≥ 75, Accessibility ≥ 95, Best Practices ≥ 90, SEO ≥ 95）。

10. **部署流程（Vercel）**
    - 连接 GitHub 仓库，启用 Preview 环境；配置 `VERCEL_ENV`、`NEXT_PUBLIC_*`、`SANITY_*` 等环境变量。
    - `vercel.json` 定义 Edge/Serverless 函数路由、缓存策略（文章详情 ISR、主页静态预渲染）。
    - 通过 GitHub Actions 在 `main` 分支合并时运行 `pnpm turbo run lint test build`，成功后触发 Vercel Production 部署。
    - 使用 Vercel Analytics 与 Speed Insights 监控真实用户性能，结合 Sentry 追踪错误。

11. **后续扩展节点**

- 引入实时数据流（Supabase Realtime 或 Vercel Realtime）展示粒子化资讯。
- 开发 AI 叙事助手：结合 LangChain + Edge Functions，提供内容推荐与语音提示。
- 用户主题工坊：允许用户组合色板/动效参数，写入用户配置并通过 CSS Variables/Shader uniforms 实时切换。
- 多语言支持：使用 `@lingui/cli` 或 `next-intl`，处理中/英/日内容。
- Edge cache 策略微调：热门文章采用 ISR + revalidateTag，长尾内容 on-demand revalidate。

#### 12. 设计开发流程与进度路线

- 采用“双轨并行”策略：设计组维护 Figma + 动效原型，开发组按组件库 → 页面 → 叙事模块顺序实现；通过每周 Design/Dev Sync 调整优先级。
- 关键阶段里程碑：
  1.  **Foundations Sprint (Week 1-2)：** Token 定义、字体/色彩落地、基础布局与滚动系统；建立 Storybook 与 R3F Playground。
  2.  **Narrative Sprint (Week 3-5)：** 首页交互段落、文章列表状态机、MDX 模块；与设计同步动画标注与音效清单。
  3.  **Immersion Sprint (Week 6-7)：** 关键帧模块、Image Lab、HUD/Tag Nebula、无障碍调优、性能优化脚本。
  4.  **Stabilization (Week 8)：** Playwright/Lighthouse 回归、CMS 接入验证、Vercel Preview 审查、内容填充。
- 每个 Sprint 含：设计文档更新 → Dev Spike → 实装 → QA → Review；必要时安排技术 Spike（例如 WebGL shader 调优）。

```mermaid
gantt
   title Chrono-Stasis Roadmap (Week-Based)
   dateFormat  YYYY-MM-DD
   section Foundations
   Design Tokens & CSS Vars        :done,     ft1, 2025-10-29, 1d
   R3F Playground & Scroll Engine  :done,          ft2, 2025-11-05, 1d
   section Narrative
   Homepage Immersion Layer        :active,         nv1, 2025-11-12, 1d
   Article Grid & MDX Pipeline     :         nv2, after nv1, 14d
   section Immersion
   Keyframe System & Image Lab     :         im1, after nv2, 10d
   HUD / Tag Nebula Integration    :         im2, after im1, 7d
   section Stabilization
   Accessibility & Performance QA  :         st1, after im2, 7d
   CMS & Content Sync              :         st2, after st1, 5d
   Launch Prep / Vercel Review     :         st3, after st2, 5d
```

#### 临时记忆栈（AI 协作备忘）

- 2025-10-30：R3F Playground 已落实粒子星云与 HUD 网格两个 Demo，`@chrono/motion` 输出 `useChronoScrollContext`、`useChronoShaderUniforms` 等 Hook；`pnpm turbo run lint` 通过，`pnpm turbo run build` 仍因 `packages/tokens` style-dictionary 配置报错需后续处理。
- 2025-10-30：Playground 构建成功（`pnpm --filter @chrono/motion-playground build`），建议后续针对 1.5 MB bundle 做手动分包或延迟加载规划。
- 2025-10-30：后续跟进 `packages/tokens` 的 `.cjs` 配置兼容（JSON5 解析报错），再复验全局 build。
- 2025-10-30：更新 lint-staged 仅对 TS/JS 运行 ESLint，解决 pre-commit 阶段警告导致的阻塞；确认手动执行 `pnpm exec lint-staged` 正常通过。
